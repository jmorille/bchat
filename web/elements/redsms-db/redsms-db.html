<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="redsms-db">

    <style>
        :host {
            display: block;
        }

    </style>

    <template>
    </template>

</dom-module>

<script>
    Polymer({ // http://www.html5rocks.com/en/tutorials/offline/storage/
        is: 'redsms-db',
        db: undefined,
        dbVersion: 1,
        tableConversation: 'conversations',
        created: function () {
            this._initDb();
            this._openDb();
        },
        _initDb: function () {
            // https://developer.mozilla.org/en-US/docs/Web/API/IndexedDB_API/Using_IndexedDB
            // In the following line, you should include the prefixes of implementations you want to test.
            window.indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB;
            // DON'T use "var indexedDB = ..." if you're not in a function.
            // Moreover, you may need references to some window.IDB* objects:
            window.IDBTransaction = window.IDBTransaction || window.webkitIDBTransaction || window.msIDBTransaction;
            window.IDBKeyRange = window.IDBKeyRange || window.webkitIDBKeyRange || window.msIDBKeyRange;
            // (Mozilla has never prefixed these objects, so we don't need window.mozIDB*)
            if (!window.indexedDB) {
                console.log("Your browser doesn't support a stable version of IndexedDB. Such and such feature will not be available.");
                return false;
            }
           // this.db = window.indexedDB;
            return true;
        },
        _openDb: function () {
            var that = this;
            var request = window.indexedDB.open("RedSmsDatabase", this.dbVersion);
            request.onupgradeneeded = this._onUpgradeNeeded.bind(this);
            request.onerror = function(event) {
                console.log("Database error: " + event.target.errorCode);
            };
            request.onsuccess = function(event) {
                that.db =  event.target.result;
                console.log('Open IndexedDb Success',  that.db);
            };
        },
        _onUpgradeNeeded: function (event) {
            var that= this;
            var db = event.target.result;
            console.log('_onUpgradeNeeded Db', db);
            if (event.oldVersion < 1) {
                // Create an objectStore for this database
                var objectStore = db.createObjectStore(this.tableConversation, {autoIncrement: true});
                objectStore.createIndex("displayName", "displayName", {unique: false});
                objectStore.createIndex("phoneNumber", "phoneNumber", {unique: true});

                // Use transaction oncomplete to make sure the objectStore creation is
                // finished before adding data into it.
                objectStore.transaction.oncomplete = function (event) {
                    // Store values in the newly created objectStore.
                    var customerObjectStore = db.transaction(that.tableConversation, "readwrite").objectStore(that.tableConversation);
                    var customerData = [
                        {displayName: 'Alice', phoneNumber: '0637474399', ordered: 0},
                        {displayName: 'Bob', phoneNumber: '0766048649', ordered: 0}
                    ];
                    for (var i in customerData) {
                        customerObjectStore.add(customerData[i]);
                    }
                }
            }
        },
        _createTransaction: function () {
            var transaction = this.db.transaction([this.tableConversation], "readwrite");
        },
        addConversation: function (data, onsuccess, onerror) {
            var transaction = this.db.transaction([this.tableConversation], "readwrite");
            transaction.oncomplete = function(event) {
                console.log("All done!");
            };

            transaction.onerror = function(event) {
                // Don't forget to handle errors!
            };
            var objectStore = transaction.objectStore(this.tableConversation);
            var request = objectStore.add(data);
            request.onsuccess = function(event) {
                // event.target.result == customerData[i].ssn;
                if (onsuccess) {
                    onsuccess(event);
                }
            };
            request.onerror = function (event) {
                if (onerror) {
                    onerror(event);
                }
            }
        }, 
        getAllConversation: function (cb) {
            var conversations = [];

            var transaction = this.db.transaction([this.tableConversation], "readwrite");
            var objectStore = transaction.objectStore(this.tableConversation );
            objectStore.openCursor().onsuccess = function(event) {
                var cursor = event.target.result;
                if (cursor) {
                    conversations.push(cursor.value);
                    cursor.continue();
                } else {
                   if (cb) {
                       console.log('Return ', conversations);
                       cb(conversations);
                   }
                }
            };

        }

    });
</script>
