<link rel="import" href="../../bower_components/polymer/polymer.html">

<dom-module id="redsms-thread">

    <style>
        :host {
            display: block;
        }
    </style>

    <template>
        <more-route context name="thread" params="{{params}}"></more-route>

        <bchat-layout route-back="root" page-title="{{conversation.displayName}}">
            <button is="paper-button" on-tap="loadDatas">Load</button>

            <template id="msgList" is="dom-repeat" items="{{messages}}">
                <div>
                    <span>{{item.name}}</span>
                    <span>: </span>
                    <span>{{item.message}}</span>
                </div>
            </template>



            <div>
                <input is="iron-input" bind-value="{{message}}" placeholder="Envoyer un SMS non-chiffrÃ©" >
                <button is="paper-icon-button" on-tap="sendMessage">Send</button>
            </div>

        </bchat-layout>
        <redsms-db id="service"  ></redsms-db>
        <redsms-sender id="sms"  ></redsms-sender>

    </template>

</dom-module>

<script>
    Polymer({
        is: 'redsms-thread',
        properties: {
            messages: {
                type: Array,
                notify: true,
                value: [
                    {name: 'Bob', message: 'Hello Alice', ordered: 0},
                    {name: 'Alice', message: 'Hi Bob!!!', ordered: 0}
                ]
            }
        },
        observers: ['_routeChange(params.threadId)'],


        ready: function() {
            this.service = this.$.service;
            if (this.params.threadId) {
                this._routeChange(this.params.threadId);
            }
        },

        _routeChange: function(threadId) {
            var that = this;
            if (!this.service || !threadId){
                that.conversation = undefined;
                return;
            }
            this.service.getConversation(threadId, function (item) {
                console.log('########## getConversation : ', threadId,   item);
                that.conversation = item;
                //that.pageTitle = item.displayName;
            });
        },
        loadDatas: function () {
            //console.log('Messages List Load Data', event, detail);
            var that = this;
            this.service.getAllMessages( that.conversation.id, function (result) {
                that.messages = result;
            });
        },

        sendMessage: function (event, data) {
            var sendMsg = {
                type: 'send',
                conversationId: this.conversation.id,
                phoneNumber: this.conversation.phoneNumber,
                name: 'me',
                message: this.message
            };
            this.service.addMessage(sendMsg);
            this.push('messages', sendMsg);
            this.$.sms.sendSms(sendMsg);
            this.message = '';
        },
        
        usersAddedOrRemoved: function (changeRecord) {
            if (!changeRecord) {
                return;
            }
            changeRecord.indexSplices.forEach(function (s) {
                s.removed.forEach(function (user) {
                    console.log(user.name + ' was  removed');
                });
                console.log(s.addedCount + ' users  were added');
            }, this);
        }

    })
    ;
</script>
